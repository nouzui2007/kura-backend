openapi: 3.0.3
info:
  title: Kura Backend API
  description: スタッフ管理、出勤記録管理、システム設定管理、給与計算を行うAPI
  version: 1.0.0
servers:
  - url: http://localhost:54321/functions/v1
    description: ローカル開発環境

tags:
  - name: Staff
    description: スタッフ管理
  - name: Attendance
    description: 出勤記録管理
  - name: SystemSettings
    description: システム設定管理
  - name: Payroll
    description: 給与計算・管理
  - name: Profile
    description: プロフィール管理

paths:
  /staff:
    get:
      tags:
        - Staff
      summary: スタッフ一覧取得
      description: スタッフの一覧を取得します
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Staff'
        '500':
          $ref: '#/components/responses/Error'
    post:
      tags:
        - Staff
      summary: スタッフ登録
      description: 新しいスタッフを登録します。IDは自動生成されます（未指定の場合）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StaffInput'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Staff'
        '400':
          $ref: '#/components/responses/Error'

  /staff/{id}:
    get:
      tags:
        - Staff
      summary: スタッフ単一取得
      description: 指定したIDのスタッフ情報を取得します
      parameters:
        - $ref: '#/components/parameters/StaffId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Staff'
        '400':
          $ref: '#/components/responses/Error'
    patch:
      tags:
        - Staff
      summary: スタッフ更新
      description: 指定したIDのスタッフ情報を更新します
      parameters:
        - $ref: '#/components/parameters/StaffId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StaffInput'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Staff'
        '400':
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/Error'
    delete:
      tags:
        - Staff
      summary: スタッフ削除
      description: 指定したIDのスタッフを削除します
      parameters:
        - $ref: '#/components/parameters/StaffId'
      responses:
        '200':
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  id:
                    type: string
        '400':
          $ref: '#/components/responses/Error'

  /attendance:
    get:
      tags:
        - Attendance
      summary: 出勤記録一覧取得
      description: 出勤記録の一覧を取得します。クエリパラメータでフィルタリング可能です
      parameters:
        - name: staffId
          in: query
          schema:
            type: string
          description: スタッフIDでフィルタリング
        - name: date
          in: query
          schema:
            type: string
            format: date
          description: 日付でフィルタリング（YYYY-MM-DD形式）
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Attendance'
        '500':
          $ref: '#/components/responses/Error'
    post:
      tags:
        - Attendance
      summary: 出勤記録登録
      description: 新しい出勤記録を登録します
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AttendanceInput'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Attendance'
        '400':
          $ref: '#/components/responses/Error'

  /attendance/bulk:
    post:
      tags:
        - Attendance
      summary: 出勤記録一括登録
      description: 複数の出勤記録を一括で登録します
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - date
                - attendanceList
              properties:
                date:
                  type: string
                  format: date
                  description: 日付（YYYY-MM-DD形式）
                attendanceList:
                  type: array
                  items:
                    type: object
                    required:
                      - staffId
                    properties:
                      staffId:
                        type: string
                      startTime:
                        type: string
                        format: time
                      endTime:
                        type: string
                        format: time
                      workHours:
                        type: number
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Attendance'
        '400':
          $ref: '#/components/responses/Error'

  /attendance/{idOrDate}:
    get:
      tags:
        - Attendance
      summary: 出勤記録取得（IDまたは日付指定）
      description: |
        UUID形式のIDを指定した場合は単一の出勤記録を取得します。
        日付形式（YYYY-MM-DD）を指定した場合は、その日付の出勤記録一覧を取得します。
      parameters:
        - name: idOrDate
          in: path
          required: true
          schema:
            type: string
          description: 出勤記録ID（UUID形式）または日付（YYYY-MM-DD形式）
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Attendance'
                  id:
                    type: string
                    format: uuid
                  date:
                    type: string
                    format: date
                  startTime:
                    type: string
                    format: time
                  endTime:
                    type: string
                    format: time
                  staffId:
                    type: string
                  workHours:
                    type: number
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
        '400':
          $ref: '#/components/responses/Error'
    patch:
      tags:
        - Attendance
      summary: 出勤記録更新
      description: 指定したID（UUID形式）の出勤記録を更新します
      parameters:
        - name: idOrDate
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 出勤記録ID（UUID形式）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AttendanceInput'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Attendance'
        '400':
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/Error'
    delete:
      tags:
        - Attendance
      summary: 出勤記録削除
      description: 指定したID（UUID形式）の出勤記録を削除します
      parameters:
        - name: idOrDate
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 出勤記録ID（UUID形式）
      responses:
        '200':
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  id:
                    type: string
        '400':
          $ref: '#/components/responses/Error'

  /system-settings:
    get:
      tags:
        - SystemSettings
      summary: システム設定一覧取得
      description: システム設定の一覧を取得します（通常は1件のみ）
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/SystemSettings'
        '500':
          $ref: '#/components/responses/Error'
    post:
      tags:
        - SystemSettings
      summary: システム設定登録
      description: 新しいシステム設定を登録します
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SystemSettingsInput'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemSettings'
        '400':
          $ref: '#/components/responses/Error'

  /system-settings/{id}:
    get:
      tags:
        - SystemSettings
      summary: システム設定単一取得
      description: 指定したIDのシステム設定を取得します
      parameters:
        - $ref: '#/components/parameters/SystemSettingsId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemSettings'
        '400':
          $ref: '#/components/responses/Error'
    patch:
      tags:
        - SystemSettings
      summary: システム設定更新
      description: システム設定を更新します
      parameters:
        - $ref: '#/components/parameters/SystemSettingsId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SystemSettingsInput'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemSettings'
        '400':
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/Error'
    delete:
      tags:
        - SystemSettings
      summary: システム設定削除
      description: 指定したIDのシステム設定を削除します
      parameters:
        - $ref: '#/components/parameters/SystemSettingsId'
      responses:
        '200':
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  id:
                    type: string
        '400':
          $ref: '#/components/responses/Error'

  /payroll/{month}:
    get:
      tags:
        - Payroll
      summary: 月次給与データ取得
      description: 指定した月の給与データを取得します
      parameters:
        - name: month
          in: path
          required: true
          schema:
            type: string
            pattern: "^\\d{4}-\\d{2}$"
          description: "月（YYYY-MM形式、例: 2025-07）"
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Payroll'
        '400':
          $ref: '#/components/responses/Error'
        '500':
          $ref: '#/components/responses/Error'

  /payroll/calculate:
    post:
      tags:
        - Payroll
      summary: 給与計算
      description: 指定した月の給与を自動計算します
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - "target-month"
              properties:
                "target-month":
                  type: string
                  pattern: "^\\d{4}-\\d{2}$"
                  description: "対象月（YYYY-MM形式、例: 2025-07）"
      responses:
        '200':
          description: 計算成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Payroll'
        '400':
          $ref: '#/components/responses/Error'
        '500':
          $ref: '#/components/responses/Error'

  /payroll:
    post:
      tags:
        - Payroll
      summary: 給与データ登録
      description: 給与データを手動で登録します
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PayrollInput'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payroll'
        '400':
          $ref: '#/components/responses/Error'

  /payroll/{id}:
    patch:
      tags:
        - Payroll
      summary: 給与データ更新
      description: 指定したIDの給与データを更新します
      parameters:
        - $ref: '#/components/parameters/PayrollId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PayrollInput'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payroll'
        '400':
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/Error'
    delete:
      tags:
        - Payroll
      summary: 給与データ削除
      description: 指定したIDの給与データを削除します
      parameters:
        - $ref: '#/components/parameters/PayrollId'
      responses:
        '200':
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  id:
                    type: string
        '400':
          $ref: '#/components/responses/Error'

  /profile:
    get:
      tags:
        - Profile
      summary: プロフィール一覧取得
      description: Authenticationの全ユーザーとそのプロフィール情報を取得します。Profileレコードがない場合はnullを返します。
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProfileWithAuth'
        '500':
          $ref: '#/components/responses/Error'
    post:
      tags:
        - Profile
      summary: プロフィール登録
      description: 新しいプロフィールを登録します
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfileInput'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '400':
          $ref: '#/components/responses/Error'

  /profile/roles:
    get:
      tags:
        - Profile
      summary: 権限リスト取得
      description: 利用可能な権限のリストを取得します
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        value:
                          type: string
                          enum:
                            - system-admin
                            - admin
                            - user
                        label:
                          type: string
                          enum:
                            - システム管理者
                            - 管理者
                            - 一般

  /profile/{id}:
    get:
      tags:
        - Profile
      summary: プロフィール単一取得
      description: 指定したIDのプロフィール情報を取得します
      parameters:
        - $ref: '#/components/parameters/ProfileId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '400':
          $ref: '#/components/responses/Error'
    patch:
      tags:
        - Profile
      summary: プロフィール更新
      description: 指定したIDのプロフィール情報を更新します
      parameters:
        - $ref: '#/components/parameters/ProfileId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfileInput'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '400':
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/Error'
    delete:
      tags:
        - Profile
      summary: プロフィール削除
      description: 指定したIDのプロフィールを削除します
      parameters:
        - $ref: '#/components/parameters/ProfileId'
      responses:
        '200':
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  id:
                    type: string
        '400':
          $ref: '#/components/responses/Error'

components:
  parameters:
    StaffId:
      name: id
      in: path
      required: true
      schema:
        type: string
      description: スタッフID
    SystemSettingsId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: システム設定ID（UUID形式）
    PayrollId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: 給与データID（UUID形式）
    ProfileId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: プロフィールID（UUID形式）

  schemas:
    Staff:
      type: object
      properties:
        id:
          type: string
          description: スタッフID
        name:
          type: string
          description: 氏名
        email:
          type: string
          format: email
          description: メールアドレス
        phone:
          type: string
          description: 電話番号
        gender:
          type: string
          description: 性別
        address:
          type: string
          description: 住所
        postalCode:
          type: string
          description: 郵便番号
        lastName:
          type: string
          description: 姓
        firstName:
          type: string
          description: 名
        lastNameKana:
          type: string
          description: 姓（カナ）
        firstNameKana:
          type: string
          description: 名（カナ）
        employeeId:
          type: string
          description: 従業員ID
        hireDate:
          type: string
          format: date
          description: 入社日
        birthDate:
          type: string
          format: date
          description: 生年月日
        workType:
          type: string
          description: 勤務形態
        workLocation:
          type: string
          description: 勤務場所
        department:
          type: string
          description: 部署
        branchName:
          type: string
          description: 支店名
        employmentType:
          type: string
          description: 雇用形態
        hourlyRate:
          type: integer
          description: 時給
        monthlySalary:
          type: integer
          description: 月給
        bankName:
          type: string
          description: 銀行名
        accountType:
          type: string
          description: 口座種別
        accountNumber:
          type: string
          description: 口座番号
        retireDate:
          type: string
          format: date
          description: 退職日
        allowances:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              amount:
                type: number
          description: 手当
        deductions:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              amount:
                type: number
          description: 控除
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    StaffInput:
      type: object
      required:
        - name
        - employeeId
      properties:
        id:
          type: string
          description: スタッフID（省略時は自動生成）
        name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        gender:
          type: string
        address:
          type: string
        postalCode:
          type: string
        lastName:
          type: string
        firstName:
          type: string
        lastNameKana:
          type: string
        firstNameKana:
          type: string
        employeeId:
          type: string
        hireDate:
          type: string
          format: date
        birthDate:
          type: string
          format: date
        workType:
          type: string
        workLocation:
          type: string
        department:
          type: string
        branchName:
          type: string
        employmentType:
          type: string
        hourlyRate:
          type: integer
        monthlySalary:
          type: integer
        bankName:
          type: string
        accountType:
          type: string
        accountNumber:
          type: string
        retireDate:
          type: string
          format: date
        allowances:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              amount:
                type: number
        deductions:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              amount:
                type: number

    Attendance:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 出勤記録ID
        date:
          type: string
          format: date
          description: 日付
        startTime:
          type: string
          format: time
          description: 開始時刻
        endTime:
          type: string
          format: time
          description: 終了時刻
        staffId:
          type: string
          description: スタッフID
        workHours:
          type: number
          description: 勤務時間（時間単位）
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AttendanceInput:
      type: object
      required:
        - date
        - startTime
        - endTime
        - staffId
        - workHours
      properties:
        date:
          type: string
          format: date
        startTime:
          type: string
          format: time
        endTime:
          type: string
          format: time
        staffId:
          type: string
        workHours:
          type: number

    SystemSettings:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 設定ID
        regularHoursPerDay:
          type: number
          description: 法定労働時間（時間/日）
        defaultBreakMinutes:
          type: integer
          description: デフォルト休憩時間（分）
        breakMinutesFor6Hours:
          type: integer
          description: 6時間超の法定休憩時間（分）
        breakMinutesFor8Hours:
          type: integer
          description: 8時間超の法定休憩時間（分）
        overtimeThreshold:
          type: number
          description: 月の残業時間閾値（時間）
        overtimeRate:
          type: number
          description: 残業割増率（%）
        excessOvertimeRate:
          type: number
          description: 超過残業割増率（%）
        lateNightRate:
          type: number
          description: 深夜割増率（%）
        holidayRate:
          type: number
          description: 休日割増率（%）
        lateNightStartHour:
          type: integer
          description: 深夜時間帯開始（時）
        lateNightEndHour:
          type: integer
          description: 深夜時間帯終了（時）
        defaultHourlyRate:
          type: integer
          description: デフォルト時給（円）
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SystemSettingsInput:
      type: object
      required:
        - regularHoursPerDay
        - defaultBreakMinutes
        - breakMinutesFor6Hours
        - breakMinutesFor8Hours
        - overtimeThreshold
        - overtimeRate
        - excessOvertimeRate
        - lateNightRate
        - holidayRate
        - lateNightStartHour
        - lateNightEndHour
        - defaultHourlyRate
      properties:
        regularHoursPerDay:
          type: number
        defaultBreakMinutes:
          type: integer
        breakMinutesFor6Hours:
          type: integer
        breakMinutesFor8Hours:
          type: integer
        overtimeThreshold:
          type: number
        overtimeRate:
          type: number
        excessOvertimeRate:
          type: number
        lateNightRate:
          type: number
        holidayRate:
          type: number
        lateNightStartHour:
          type: integer
        lateNightEndHour:
          type: integer
        defaultHourlyRate:
          type: integer

    Payroll:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 給与ID
        month:
          type: string
          pattern: "^\\d{4}-\\d{2}$"
          description: 対象月（YYYY-MM形式）
        staffId:
          type: string
          description: スタッフID
        data:
          type: object
          additionalProperties: true
          description: 給与計算結果データ（JSON形式）
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PayrollInput:
      type: object
      required:
        - month
        - staffId
      properties:
        month:
          type: string
          pattern: "^\\d{4}-\\d{2}$"
        staffId:
          type: string
        data:
          type: object
          additionalProperties: true

    Profile:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: プロフィールID
        uid:
          type: string
          format: uuid
          description: AuthenticationのユーザーID
        username:
          type: string
          nullable: true
          description: ユーザー名
        role:
          type: string
          enum:
            - system-admin
            - admin
            - user
          description: 権限
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProfileInput:
      type: object
      required:
        - uid
      properties:
        uid:
          type: string
          format: uuid
          description: AuthenticationのユーザーID
        username:
          type: string
          nullable: true
          description: ユーザー名
        role:
          type: string
          enum:
            - system-admin
            - admin
            - user
          default: user
          description: 権限

    ProfileWithAuth:
      type: object
      properties:
        id:
          type: string
          format: uuid
          nullable: true
          description: プロフィールID（Profileレコードがない場合はnull）
        uid:
          type: string
          format: uuid
          description: AuthenticationのユーザーID
        email:
          type: string
          nullable: true
          description: メールアドレス
        username:
          type: string
          nullable: true
          description: ユーザー名
        role:
          type: string
          nullable: true
          enum:
            - system-admin
            - admin
            - user
          description: 権限（Profileレコードがない場合はnull）
        has_profile:
          type: boolean
          description: Profileレコードが存在するかどうか
      required:
        - id
        - uid
        - has_profile

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: エラーメッセージ
      required:
        - error

  responses:
    Error:
      description: エラーレスポンス
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
